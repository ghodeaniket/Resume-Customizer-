name: Resume Customizer CD

on:
  # Trigger the workflow on push to main or manual dispatch
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'dev' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm run test:ci
      
    - name: Run linting
      run: |
        # Ensure we use ESLint v8 to match .eslintrc.js config
        npm uninstall eslint
        npm install --no-save eslint@8.57.0
        npm run lint
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    - name: Install serverless framework
      run: npm install -g serverless
    
    - name: Create serverless configuration
      run: |
        cat > serverless.yml << 'EOL'
        service: resume-customizer-backend

        provider:
          name: aws
          runtime: nodejs18.x
          region: ${opt:region, env:AWS_REGION, 'us-east-1'}
          stage: ${opt:stage, env:STAGE, 'dev'}
          environment:
            NODE_ENV: ${self:provider.stage}
            # Add your environment variables here
            DB_HOST: ${ssm:/resume-customizer/${self:provider.stage}/db/host, 'localhost'}
            DB_NAME: ${ssm:/resume-customizer/${self:provider.stage}/db/name, 'resume_customizer'}
            DB_USER: ${ssm:/resume-customizer/${self:provider.stage}/db/user, 'postgres'}
            DB_PASSWORD: ${ssm:/resume-customizer/${self:provider.stage}/db/password, 'password'}
            JWT_SECRET: ${ssm:/resume-customizer/${self:provider.stage}/jwt/secret, 'dev-secret'}
          iam:
            role:
              statements:
                - Effect: Allow
                  Action:
                    - dynamodb:Query
                    - dynamodb:Scan
                    - dynamodb:GetItem
                    - dynamodb:PutItem
                    - dynamodb:UpdateItem
                    - dynamodb:DeleteItem
                  Resource: 
                    - !GetAtt ResumeTable.Arn
                - Effect: Allow
                  Action:
                    - s3:GetObject
                    - s3:PutObject
                    - s3:DeleteObject
                  Resource: 
                    - !Sub arn:aws:s3:::${self:service}-${self:provider.stage}-resumes/*
                    - !Sub arn:aws:s3:::${self:service}-${self:provider.stage}-resumes

        functions:
          api:
            handler: src/serverless.handler
            events:
              - httpApi:
                  path: /{proxy+}
                  method: ANY
            timeout: 30
            memorySize: 1024

        resources:
          Resources:
            ResumeTable:
              Type: AWS::DynamoDB::Table
              Properties:
                TableName: ${self:service}-${self:provider.stage}-resumes
                BillingMode: PAY_PER_REQUEST
                AttributeDefinitions:
                  - AttributeName: id
                    AttributeType: S
                KeySchema:
                  - AttributeName: id
                    KeyType: HASH
                StreamSpecification:
                  StreamViewType: NEW_AND_OLD_IMAGES
            
            ResumesBucket:
              Type: AWS::S3::Bucket
              Properties:
                BucketName: ${self:service}-${self:provider.stage}-resumes
                CorsConfiguration:
                  CorsRules:
                    - AllowedHeaders:
                        - '*'
                      AllowedMethods:
                        - GET
                        - PUT
                        - POST
                        - DELETE
                        - HEAD
                      AllowedOrigins:
                        - '*'
                      MaxAge: 3000
        EOL
    
    - name: Create serverless entry point
      run: |
        mkdir -p src
        cat > src/serverless.js << 'EOL'
        const serverless = require('serverless-http');
        const app = require('./app');

        module.exports.handler = serverless(app);
        EOL
    
    - name: Deploy to AWS using Serverless
      run: |
        STAGE="${{ github.event.inputs.environment || 'dev' }}"
        echo "Deploying to AWS $STAGE environment..."
        serverless deploy --stage $STAGE --verbose
      
    - name: Store deployment info in SSM
      run: |
        STAGE="${{ github.event.inputs.environment || 'dev' }}"
        API_URL=$(serverless info --stage $STAGE --verbose | grep -o 'HttpApiUrl:.*' | cut -d' ' -f2)
        aws ssm put-parameter --name "/resume-customizer/$STAGE/api/url" --value "$API_URL" --type String --overwrite
    
    - name: Send deployment notification
      run: |
        STAGE="${{ github.event.inputs.environment || 'dev' }}"
        echo "Deployment to $STAGE completed!"
        echo "API URL: $(aws ssm get-parameter --name "/resume-customizer/$STAGE/api/url" --query 'Parameter.Value' --output text)"
